package storexml;

import db.DBConnection;

import java.io.InputStream;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.util.logging.Logger;

public class StoreXML {

	public static Connection con;
	public static Logger logg = Logger.getLogger("Log1");
	public StoreXML(InputStream pathxml,String contract, double contract_value) throws Exception
	{

		DBConnection db=new DBConnection();
		con=db.getConnection();
		logg.info("Inside store xml class to store data in database");
		PreparedStatement pstmt=null;


		if (pathxml!=null ) {
			String sql="insert into store_files(fid,xmlfile,pdffile,lcda_amt) values (?,?,?,?)";
			pstmt=con.prepareStatement(sql);
			pstmt.setString(1, contract);
			pstmt.setAsciiStream(2, pathxml);
			pstmt.setDouble(4,contract_value);
			pstmt.executeUpdate();
			con.commit();
			pstmt.close();
			con.close();
			//logg.info("Record inserted in database");
		}
	}


}



package com.tcs.xml;

import com.jcraft.jsch.ChannelSftp;
import com.jcraft.jsch.JSch;

import com.jcraft.jsch.Session;
import com.jcraft.jsch.SftpException;
import java.io.*;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.Properties;
import java.util.Vector;
import java.util.logging.Logger;
import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import org.w3c.dom.Document;
import storexml.StoreXML;

public class SFTPFile
{

	public static Logger logg = Logger.getLogger("Log1");
	public static String contract=null;
	public static String br_code=null;
	Vector<ChannelSftp.LsEntry> list=null;
	public static String outbox="";
	public static String remoteFile="";   
	static String outputPath="";
	public static String remoteFile1="";   
	StoreXML str_xml;
	public static  ChannelSftp sftpChannel=null;
	JSch jsch = new JSch();
	Session session=null;
	Properties pr=new Properties();
	@SuppressWarnings("unchecked")
	public void sftpfile()
	{
		String ftppath,xml,user,password,host,filename;
		int port;
		Properties pr;
		pr=new Properties();
		try{
			pr.load(new FileInputStream("properties/XmlReadPath.properties"));
			remoteFile=pr.getProperty("path");
			user=pr.getProperty("user"); 
			host=pr.getProperty("host");
			password=pr.getProperty("password");
			port=Integer.parseInt(pr.getProperty("port"));
			logg.info("user"+user+"\n"+"host"+host+"\n"+"port"+port);
			session = jsch.getSession(user, host, port);
			session.setPassword(password);
			session.setConfig("StrictHostKeyChecking", "no");
			session.connect();
			logg.info("Connection established.");
			sftpChannel = (ChannelSftp) session.openChannel("sftp");
			sftpChannel.connect();
			sftpChannel.cd(remoteFile);
			list = sftpChannel.ls("*.xml");
			logg.info("list Value : [" + list + "] sftpChannel : [" + sftpChannel + "]");
			ftppath=pr.getProperty("ftppath");
			for(ChannelSftp.LsEntry entry : list) {
				DocumentBuilderFactory docbuildFactory = DocumentBuilderFactory.newInstance();
				DocumentBuilder docBuilder;
				InputStream is=null;
				try {
					is = sftpChannel.get(remoteFile+entry.getFilename());
					
				} catch (SftpException e1) {
					e1.printStackTrace();
				}

				docBuilder = docbuildFactory.newDocumentBuilder();
				Document document = docBuilder.parse(is);
				document.getDocumentElement ().normalize ();

				ftppath=pr.getProperty("ftppath");
				filename=pr.getProperty("filename");
				xml=remoteFile+contract+filename+".xml";
				sftpChannel.get(xml, ftppath);
				logg.info("xml copied successfully:"+contract);
				is=sftpChannel.get(xml);	

					
				if(remoteFile1!=null)
				{	
					try
					{
						str_xml=new StoreXML(is,contract);
						success();
						logg.info("Record inserted in database successfully:"+contract);
						is.close();

						sftpChannel.rm(xml);

					}catch(Exception e){
						fail(e);
						e.printStackTrace();
					}
				}	

			}

			session.disconnect();
		}catch(Exception e)
		{logg.info("xml and pdf are not copied"+contract);
			fail(e);
			e.printStackTrace();

		}
	}

	public static void success()
	{

		String sucess=contract+"_success";
		String absoluteFilePath =sucess+".txt";
		File file = new File(absoluteFilePath);
		Properties pr2;
		pr2=new Properties();
		try {
			pr2.load(new FileInputStream("properties/XmlReadPath.properties"));
			outbox=pr2.getProperty("ackPath");
			sftpChannel.cd(outbox);
			String fileData =contract + " successfully recieved. ";
			Files.write(Paths.get(absoluteFilePath), fileData.getBytes());
			if(file.isFile()){
				String put=outbox + file.getName();
				InputStream ins = new FileInputStream(file);
				sftpChannel.put(ins, put);
				ins.close();
				file.delete();
			}

		}catch (SftpException e) {

			e.printStackTrace();
		} catch (FileNotFoundException e) {
			e.printStackTrace();
		} catch (IOException e) {
			e.printStackTrace();
		}
		logg.info("Success Acknowledgement generated:"+contract);

	}

	public static void fail(Exception e2)
	{ 
		String fail=contract+"_fail";
		String absoluteFilePath =fail+".txt";
		File file = new File(absoluteFilePath);
		Properties pr2;
		pr2=new Properties();
		try {
			pr2.load(new FileInputStream("properties/XmlReadPath.properties"));
			outbox=pr2.getProperty("ackPath");
			sftpChannel.cd(outbox);
			String fileData =contract + " failed due to reason "+e2;
			Files.write(Paths.get(absoluteFilePath), fileData.getBytes());
			if(file.isFile()){
				String put=outbox + file.getName();
				InputStream ins = new FileInputStream(file);
				sftpChannel.put(ins,put);
				ins.close();
				file.delete();
			}

		}catch (SftpException e) {
			e.printStackTrace();
		} catch (FileNotFoundException e) {
			e.printStackTrace();
		} catch (IOException e) {
			e.printStackTrace();
		}

		logg.info("Failure Acknowledgement generated:"+contract);

	}

}



    /*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package exception;

import java.io.PrintWriter;
import java.io.StringWriter;

public class MyException
{
	public static String exce(Exception e)
	{
		StringWriter sw = new StringWriter();
		e.printStackTrace(new PrintWriter(sw));
		return sw.toString();
	}
}


    package storexml;

import db.DBConnection;

import java.io.InputStream;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.util.logging.Logger;

public class StoreXML {

	public static Connection con;
	public static Logger logg = Logger.getLogger("Log1");
	public StoreXML(InputStream pathxml,String contract) throws Exception
	{

		DBConnection db=new DBConnection();
		con=db.getConnection();
		logg.info("Inside store xml class to store data in database");
		PreparedStatement pstmt=null;


		if (pathxml!=null ) {
			String sql="insert into store_files(fid,xmlfile) values (?,?)";
			pstmt=con.prepareStatement(sql);
			pstmt.setString(1, contract);
			pstmt.setAsciiStream(2, pathxml);
			pstmt.executeUpdate();
			con.commit();
			pstmt.close();
			con.close();
			//logg.info("Record inserted in database");
		}
	}


}
