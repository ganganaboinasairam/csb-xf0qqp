<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSP Div Converter</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .result {
            margin-top: 20px;
        }
        pre {
            background-color: #f4f4f4;
            border: 1px solid #ccc;
            padding: 10px;
            overflow: auto;
        }
    </style>
</head>
<body>

<h1>JSP Div Converter</h1>
<p>Select a JSP file to convert the div structures.</p>
<input type="file" id="jspFile" accept=".jsp"><br>
<button onclick="convertDivs()">Convert Divs</button>

<div class="result" id="result"></div>

<script>
function readFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsText(file);
    });
}

function convertDivs() {
    const fileInput = document.getElementById('jspFile');
    const resultDiv = document.getElementById('result');

    if (fileInput.files.length === 0) {
        alert("Please select a JSP file.");
        return;
    }

    const file = fileInput.files[0];
    readFile(file).then(content => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(content, 'text/html');

        // Process the document
        handleCustomFormatting(doc);
        appendStyleAndScript(doc);

        // Serialize the modified HTML document
        const serializer = new XMLSerializer();
        let outputHtml = serializer.serializeToString(doc);

        resultDiv.innerHTML = `<pre>${escapeHtml(outputHtml)}</pre>`;
    }).catch(error => {
        console.error('Error reading file:', error);
    });
}

function handleCustomFormatting(doc) {
    // Ensure EXIMTAGS are self-closing and uppercase
    const eximtags = doc.querySelectorAll('eximtags\\:includefile');
    eximtags.forEach(tag => {
        // Remove any closing EXIMTAGS tags and convert to uppercase
        tag.outerHTML = tag.outerHTML.replace(/<\/eximtags:[^>]*>/gi, '');
        tag.outerHTML = tag.outerHTML.toUpperCase();
    });

    // Ensure JSP includes are self-closing
    const jspIncludes = doc.querySelectorAll('jsp\\:include');
    jspIncludes.forEach(tag => {
        tag.outerHTML = tag.outerHTML.replace(/<\/jsp:include>/gi, '/>');
    });
}

function appendStyleAndScript(doc) {
    const styleTag = '<style>/* Your default styles here */</style>';
    const scriptTag = '<script>/* Your default script here */</script>';

    // Check if <jsp:include> tags are present and append style/script if needed
    doc.querySelectorAll('jsp\\:include').forEach(include => {
        if (!include.nextElementSibling || 
            (include.nextElementSibling.tagName !== 'STYLE' && include.nextElementSibling.tagName !== 'SCRIPT')) {
            include.insertAdjacentHTML('afterend', styleTag + scriptTag);
        }
    });

    // Check if <eximtags:includefile> tags are present and append style/script if needed
    doc.querySelectorAll('eximtags\\:includefile').forEach(include => {
        if (!include.nextElementSibling || 
            (include.nextElementSibling.tagName !== 'STYLE' && include.nextElementSibling.tagName !== 'SCRIPT')) {
            include.insertAdjacentHTML('afterend', styleTag + scriptTag);
        }
    });
}

function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}
</script>

</body>
</html>