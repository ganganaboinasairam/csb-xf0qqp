package com.tcs.xml;

import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.Properties;
import java.util.logging.Logger;
import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import org.w3c.dom.Document;
import storexml.StoreXML;

public class SFTPFile {
    private static final Logger logg = Logger.getLogger("Log1");
    private static final Properties pr = new Properties();

    public void processLocalFiles() {
        try {
            pr.load(new FileInputStream("properties/XmlReadPath.properties"));
            String localDir = pr.getProperty("localDir");
            logg.info("Processing files from local directory: " + localDir);

            Files.newDirectoryStream(Paths.get(localDir), "*.xml")
                .forEach(path -> {
                    try (InputStream is = Files.newInputStream(path)) {
                        DocumentBuilderFactory docbuildFactory = DocumentBuilderFactory.newInstance();
                        DocumentBuilder docBuilder = docbuildFactory.newDocumentBuilder();
                        Document doc = docBuilder.parse(is); // To ensure XML is well-formed

                        String contract = "Contract_" + LocalDate.now().format(DateTimeFormatter.BASIC_ISO_DATE);
                        StoreXML str_xml = new StoreXML(is, contract);

                        logg.info("Record inserted in database successfully: " + contract);
                        Files.delete(path);
                        success(contract);
                    } catch (Exception e) {
                        logg.severe("Failed to process file: " + path);
                        logg.severe("Error message: " + e.getMessage());
                        fail(e);
                    }
                });
        } catch (IOException e) {
            logg.severe("Failed to load properties or process directory: " + e.getMessage());
            fail(e);
        }
    }

    public static void success(String contract) {
        String successMessage = contract + "_success.txt";
        try {
            Files.write(Paths.get(successMessage), (contract + " successfully processed.").getBytes());
            logg.info("Success Acknowledgement generated: " + contract);
        } catch (IOException e) {
            logg.severe("Failed to generate success acknowledgment: " + e.getMessage());
        }
    }

    public static void fail(Exception e) {
        String failureMessage = "failure_acknowledgement.txt";
        try {
            Files.write(Paths.get(failureMessage), ("Processing failed due to: " + e.getMessage()).getBytes());
            logg.info("Failure Acknowledgement generated.");
        } catch (IOException ioException) {
            logg.severe("Failed to generate failure acknowledgment: " + ioException.getMessage());
        }
    }

    public static void main(String[] args) {
        SFTPFile sftpFile = new SFTPFile();
        sftpFile.processLocalFiles();
    }
}