package com.tcs.xml;

import com.jcraft.jsch.ChannelSftp;
import com.jcraft.jsch.JSch;
import com.jcraft.jsch.Session;
import com.jcraft.jsch.SftpException;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.InputStream;
import java.nio.file.Files;
import java.nio.file.OpenOption;
import java.nio.file.Paths;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.Properties;
import java.util.Vector;
import java.util.logging.Logger;
import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import org.w3c.dom.Document;
import storexml.StoreXML;

@SuppressWarnings("unused")
public class SFTPFile
{
  public static Logger logg = Logger.getLogger("Log1");
  public static String lcda = null;
  String contract =null;
  public static double lcdavalue = 0.0D;
  public static String br_code = null;
  Vector<ChannelSftp.LsEntry> list = null;
  public static String outbox = "";
  public static String remoteFile = "";
  static String outputPath = "";
  public static String remoteFile1 = "";
  StoreXML str_xml;
  public static ChannelSftp sftpChannel = null;
  JSch jsch = new JSch();
  Session session = null;
  Properties pr = new Properties();

  public void sftpfile()
  {
    Properties pr = new Properties();
    try {
      pr.load(new FileInputStream("properties/XmlReadPath.properties"));
      remoteFile = pr.getProperty("path");
      String user = pr.getProperty("user");
      String host = pr.getProperty("host");
      String password = pr.getProperty("password");
      String localDir = pr.getProperty("localDir");
      int port = Integer.parseInt(pr.getProperty("port"));
      logg.info("user" + user + "\n" + "host" + host + "\n" + "port" + port);
      	System.out.println("-------------localDir "+localDir);
        Files.newDirectoryStream(Paths.get(localDir), "*.xml")
        .forEach(path -> {
            try (InputStream is = Files.newInputStream(path)) {
            	System.out.println("-------------InputStream "+is);
                DocumentBuilderFactory docbuildFactory = DocumentBuilderFactory.newInstance();
                DocumentBuilder docBuilder = docbuildFactory.newDocumentBuilder();
                docBuilder.parse(is);

                // Generate contract ID in Contract_YYYYMMDD format
                String contract = "Contract_" + LocalDate.now().format(DateTimeFormatter.BASIC_ISO_DATE);

                // Store XML content in the database
                StoreXML str_xml = new StoreXML(is, contract);
                logg.info("Record inserted in database successfully: " + contract);

                // Simulate file removal after processing
                Files.delete(path);

                // Call success method after processing
                success(contract);

            } catch (Exception e) {
                logg.severe("Failed to process file: " + path);
                logg.severe("Error message: " + e.getMessage());
            }
        });
        
      this.session.disconnect();
    } catch (Exception e) {
      logg.info("xml and pdf are not copied" + contract);
      fail(e);
      e.printStackTrace();
    }
  }

  public static void success(String contract)
  {
    String sucess = contract + "_success";
    String absoluteFilePath = sucess + ".txt";
    File file = new File(absoluteFilePath);

    Properties pr2 = new Properties();
    try {
      pr2.load(new FileInputStream("properties/XmlReadPath.properties"));
      outbox = pr2.getProperty("ackPath");
      sftpChannel.cd(outbox);
      String fileData = contract + " successfully recieved. ";
      Files.write(Paths.get(absoluteFilePath, new String[0]), fileData.getBytes(), new OpenOption[0]);
      if (file.isFile()) {
        String put = outbox + file.getName();
        InputStream ins = new FileInputStream(file);
        sftpChannel.put(ins, put);
        ins.close();
        file.delete();
      }
    }
    catch (SftpException e)
    {
      e.printStackTrace();
    } catch (FileNotFoundException e) {
      e.printStackTrace();
    } catch (IOException e) {
      e.printStackTrace();
    }
    logg.info("Success Acknowledgement generated:" + lcda);
  }

  public static void fail(Exception e2)
  {
	  System.out.println("------------inside-fail "); 
	  
    String fail = lcda + "_fail";
    String absoluteFilePath = fail + ".txt";
    File file = new File(absoluteFilePath);

    Properties pr2 = new Properties();
    try {
      pr2.load(new FileInputStream("properties/XmlReadPath.properties"));
      outbox = pr2.getProperty("ackPath");
      String fileData = lcda + " failed due to reason " + e2;
      Files.write(Paths.get(absoluteFilePath, new String[0]), fileData.getBytes(), new OpenOption[0]);
      if (file.isFile()) {
        String put = outbox + file.getName();
        InputStream ins = new FileInputStream(file);
        
        ins.close();
        file.delete();
      }
    }
    catch (FileNotFoundException e) {
      e.printStackTrace();
    } catch (IOException e) {
      e.printStackTrace();
    }

    logg.info("Failure Acknowledgement generated:" + lcda);
  }
}






package storexml;

import db.DBConnection;
import java.io.InputStream;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.util.logging.Logger;

public class StoreXML
{
  public static Connection con;
  public static Logger logg = Logger.getLogger("Log1");

  public StoreXML(InputStream pathxml, String contract) throws Exception
  {
    DBConnection db = new DBConnection();
    con = db.getConnection();
    logg.info("Inside store xml class to store data in database");
    PreparedStatement pstmt = null;

    if ((pathxml != null)) {
      String sql = "insert into store_files(fid,xmlfile) values (?,?)";
      pstmt = con.prepareStatement(sql);
      pstmt.setString(1, contract);
      pstmt.setAsciiStream(2, pathxml);
      pstmt.executeUpdate();
      con.commit();
      pstmt.close();
      con.close();
    }
  }
}






package db;

import static exception.MyException.exce;
import java.io.FileInputStream;
import java.sql.Connection;
import java.sql.DriverManager;
import java.util.Properties;
import java.util.logging.Logger;

import com.tcs.password.decryption.Decryption;
public class DBConnection 
{
	private static String driver,dbURL,dbUserName,dbPassword;
	public static Logger logg = Logger.getLogger("Log1");

	@SuppressWarnings("finally")
	public Connection getConnection()
	{
		Connection con=null;
		Properties pr;
		try
		{
			pr=new Properties();
			pr.load(new FileInputStream("properties/XmlReadDBInfo.properties"));
			driver=pr.getProperty("driver");
			dbURL=pr.getProperty("connString");
			dbUserName=pr.getProperty("userName");
			dbPassword=Decryption.decrypt(pr.getProperty("pwd"));
			logg.info("driver :"+driver+"\n"+"dbURL :"+dbURL+"\n"+"dbUserName :"+dbUserName);
			Class.forName(driver);
			con=DriverManager.getConnection(dbURL,dbUserName,dbPassword);
		}
		catch(Exception e)
		{
			System.out.println(""+exce(e));

		}
		finally
		{	
			return con;
		}
	}

}
