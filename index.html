package com.cs.ceweb.servlets;

import java.io.IOException;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.json.JSONObject;

import com.cs.core.dao.DSManager;

public class GetRailLCDetails extends HttpServlet {

    private static final long serialVersionUID = 1L;

    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        String requestType = request.getParameter("reqType");
        String contractId = request.getParameter("contractId");

        if (contractId == null || contractId.isEmpty() || requestType == null || requestType.isEmpty()) {
            sendErrorResponse(response, "Invalid request");
            return;
        }

        try (Connection conn = DSManager.getConnection("CET")) {
            response.setContentType("application/json");

            if ("getContractDetails".equals(requestType)) {
                processRequest(conn, response, contractId);
            } else if ("validateContractID".equals(requestType)) {
                processRequest(conn, response, contractId);
            } else {
                sendErrorResponse(response, "Invalid request");
            }
        } catch (Exception e) {
            e.printStackTrace();
            sendErrorResponse(response, "An error occurred");
        }
    }

    private void processRequest(Connection conn, HttpServletResponse response, String contractId) throws IOException {
        String query = "SELECT STATUS, LC_NO FROM INIS_MASTER WHERE CONTRACT_ID = ?";

        try (PreparedStatement pstmt = conn.prepareStatement(query)) {
            pstmt.setString(1, contractId);
            try (ResultSet rs = pstmt.executeQuery()) {
                if (rs.next()) {
                    String status = rs.getString("STATUS");
                    String lcNo = rs.getString("LC_NO");

                    JSONObject responseJson = new JSONObject();
                    responseJson.put("contractId", contractId);
                    responseJson.put("status", status);
                    responseJson.put("lcNo", lcNo);

                    String jsonResponse = responseJson.toString();
                    response.getWriter().write(jsonResponse);
                } else {
                    sendErrorResponse(response, "Invalid Contract ID, Please check");
                }
            }
        } catch (Exception e) {
            e.printStackTrace();
            sendErrorResponse(response, "An error occurred");
        }
    }

    private void sendErrorResponse(HttpServletResponse response, String errorMessage) throws IOException {
        response.setContentType("application/json");
        response.getWriter().write("{\"error\": \"" + errorMessage + "\"}");
    }
}