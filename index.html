package sftpConnect;


import java.io.FileInputStream;
import java.io.InputStream;
import java.util.Properties;
import java.util.Vector;
import java.util.logging.Logger;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;

import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.NodeList;

import com.jcraft.jsch.ChannelSftp;
import com.jcraft.jsch.JSch;
import com.jcraft.jsch.Session;

import storexml.StoreXML;

public class connectSFTP {
	public static Logger logg = Logger.getLogger("Log1");
	  Vector<ChannelSftp.LsEntry> list = null;
	  public static String remoteFile = "";
	  public static ChannelSftp sftpChannel = null;
	  JSch jsch = new JSch();
	  Session session = null;
	  Properties pr = new Properties();
@SuppressWarnings("unused")
public void sftpfile()
  {
    Properties pr = new Properties();
    try {
      pr.load(new FileInputStream("properties/XmlReadPath.properties"));
      remoteFile = pr.getProperty("path");
      String user = pr.getProperty("user");
      String host = pr.getProperty("host");
      String password = pr.getProperty("password");
      int port = Integer.parseInt(pr.getProperty("port"));
      logg.info("user: " + user + "\n" + "host: " + host + "\n" + "port: " + port);

      this.session = this.jsch.getSession(user, host, port);
      this.session.setPassword(password);
      this.session.setConfig("StrictHostKeyChecking", "no");
      this.session.connect();
      logg.info("Connection established.");
      sftpChannel = (ChannelSftp)this.session.openChannel("sftp");
      sftpChannel.connect();
      sftpChannel.cd(remoteFile);
      
      logg.info("list Value : [" + this.list + "] sftpChannel : [" + sftpChannel + "]");
      
      for (ChannelSftp.LsEntry entry : this.list) {
          try (InputStream is = sftpChannel.get(remoteFile + entry.getFilename())) {
              logg.info("Processing file: " );

              DocumentBuilderFactory docbuildFactory = DocumentBuilderFactory.newInstance();
              DocumentBuilder docBuilder = docbuildFactory.newDocumentBuilder();
              Document doc = docBuilder.parse(is);

              NodeList contractList = doc.getElementsByTagName("CONTRACTDTL");

              for (int i = 0; i < contractList.getLength(); i++) {
                  Element contractElement = (Element) contractList.item(i);
                  String contractId = contractElement.getElementsByTagName("CONTRACTID").item(0).getTextContent();
                  String contractValue = contractElement.getElementsByTagName("CONTRACT_VALUE").item(0).getTextContent();

                  logg.info("Generated contract ID: " + contractId);

                 
                  StoreXML str_xml = new StoreXML(contractElement, contractId, contractValue);
                  logg.info("Record inserted in database successfully: " + contractId);
              }
              
          } catch (Exception e) {
              logg.severe("Failed to process file: " );
              logg.severe("Error message: " + e.getMessage());
          }
      };
      this.session.disconnect();
    } catch (Exception e) {
      e.printStackTrace();
    }
  }
public static void main(String[] args) throws InterruptedException , Exception{
	connectSFTP sftpFile = new connectSFTP();
        sftpFile.sftpfile();
}
}
