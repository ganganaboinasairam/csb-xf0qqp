package com.cs.ceweb.servlets;

import java.io.IOException;
import java.io.StringReader;
import java.io.StringWriter;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.util.ArrayList;
import java.util.List;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;

import org.json.JSONObject;
import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.Node;
import org.w3c.dom.NodeList;
import org.xml.sax.InputSource;

import com.cs.core.dao.DSManager;
import com.google.gson.Gson;

import javax.xml.transform.OutputKeys;
import javax.xml.transform.Transformer;
import javax.xml.transform.TransformerFactory;
import javax.xml.transform.dom.DOMSource;
import javax.xml.transform.stream.StreamResult;


public class getRailLCDetails extends HttpServlet {
    private static final long serialVersionUID = 1L;

    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        String requestType = request.getParameter("reqType");
        String contractId = request.getParameter("contractId");

        Connection conn = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;

        try {
            response.setContentType("application/json");
            conn = DSManager.getConnection("CET");

            if (requestType.equals("getContractDetails") && contractId != null && !contractId.isEmpty()) {
                try {
                	System.out.println("requestType is :" + requestType +"AND "+ contractId);
                    String query = "SELECT LC_DETAIL FROM RAIL_LC";
                    pstmt = conn.prepareStatement(query);
                    rs = pstmt.executeQuery();

                    List<String> contractList = new ArrayList<>();
                    DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
                    DocumentBuilder builder = factory.newDocumentBuilder();

                    while (rs.next()) {
                        String lcDetailXml = rs.getString("LC_DETAIL");
                        System.out.println("lcDetailXml is :" + lcDetailXml);

                        if (lcDetailXml != null && !lcDetailXml.trim().isEmpty()) {
                        	
                        	System.out.println("lcDetailXml is :" + (lcDetailXml != null && !lcDetailXml.trim().isEmpty()));
                            lcDetailXml = lcDetailXml.replaceFirst("^<\\?xml.*\\?>", "").trim();

                            try {
                            	System.out.println("-------------inside try block -----------------");
                                InputSource is = new InputSource(new StringReader(lcDetailXml));
                                System.out.println("InputSource is :" + new InputSource(new StringReader(lcDetailXml)));
                                Document doc = builder.parse(is);
                                System.out.println("doc is :" + doc);

                                if (doc != null) {
                                    NodeList contractNodes = doc.getElementsByTagName("CONTRACTDTL");
                                    System.out.println("contractNodes length is :" + contractNodes.getLength());

                                    for (int i = 0; i < contractNodes.getLength(); i++) {
                                        Element contractElement = (Element) contractNodes.item(i);
                                        String currentContractId = contractElement.getElementsByTagName("CONTRACTID").item(0).getTextContent();

                                        if (currentContractId.equals(contractId)) {
                                            contractList.add(nodeToString(contractElement));
                                        }
                                    }
                                } else {
                                    System.err.println("Document parsing resulted in null");
                                }
                            } catch (Exception e) {
                                System.err.println("Error parsing XML: " + lcDetailXml);
                                e.printStackTrace(); 
                            }
                        } else {
                            System.err.println("Empty or null LC_DETAIL encountered");
                        }
                    }

                    Gson gs = new Gson();
                    String jsonList = gs.toJson(contractList);
                    System.out.println("list is " + jsonList);
                    response.getWriter().write(jsonList);

                } catch (Exception e) {
                    e.printStackTrace();
                }
            } else if (requestType.equals("validateContractID") && contractId != null && !contractId.isEmpty()) {
                try {
                	System.out.println("requestType is :" + requestType );
                    System.out.println("Validating contractId: " + contractId);

                    String query = "SELECT STATUS, LC_NO FROM INIS_MASTER WHERE CONTRACT_ID = ?";
                    pstmt = conn.prepareStatement(query);
                    pstmt.setString(1, contractId);
                    rs = pstmt.executeQuery();

                    if (rs.next()) {
                        String status = rs.getString("STATUS");
                        String lcNo = rs.getString("LC_NO");

                        JSONObject responseJson = new JSONObject();
                        responseJson.put("contractId", contractId);
                        responseJson.put("status", status);
                        responseJson.put("lcNo", lcNo);

                        String jsonResponse = responseJson.toString();
                        response.getWriter().write(jsonResponse);
                    } else {
                        response.setContentType("application/json");
                        response.getWriter().write("{\"error\": \"Invalid Contract ID, Please check\"}");
                    }

                } catch (Exception e) {
                    e.printStackTrace();
                    response.setContentType("application/json");
                    response.getWriter().write("{\"error\": \"An error occurred\"}");
                }
            } else {
                response.setContentType("application/json");
                response.getWriter().write("{\"error\": \"Invalid request\"}");
            }

        } catch (Exception e) {
            e.printStackTrace();
            System.out.println("Exception for GetRailLCDetails");
        } finally {
            try {
                if (conn != null) conn.close();
                if (rs != null) rs.close();
                if (pstmt != null) pstmt.close();
            } catch (Exception e) {
                e.printStackTrace();
                System.out.println("Exception while closing resources");
            }
        }
    }

    private String nodeToString(Node node) throws Exception {
        StringWriter sw = new StringWriter();
        Transformer t = TransformerFactory.newInstance().newTransformer();
        t.setOutputProperty(OutputKeys.OMIT_XML_DECLARATION, "yes");
        t.setOutputProperty(OutputKeys.INDENT, "yes");
        t.transform(new DOMSource(node), new StreamResult(sw));
        return sw.toString();
    }
}
