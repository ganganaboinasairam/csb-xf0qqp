package uatSftp;

import com.jcraft.jsch.ChannelSftp;
import com.jcraft.jsch.JSch;
import com.jcraft.jsch.Session;
import com.jcraft.jsch.SftpException;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.InputStream;
import java.util.ArrayList;
import java.util.List;
import java.util.Properties;
import java.util.logging.Logger;

public class SFTPFileTransfer {
    private static Logger logger = Logger.getLogger(SFTPFileTransfer.class.getName());
    private static ChannelSftp sftpChannel = null;
    private Session session = null;
    private JSch jsch = new JSch();

    private String host;
    private String user;
    private String password;
    private int port;
    private String localReplicaRoot;
    private String remoteFilePath;
    private static String mode;

    public SFTPFileTransfer() {
        try {
            Properties pr = new Properties();
            pr.load(new FileInputStream("properties/XmlReadPath.properties"));

            this.host = pr.getProperty("host");
            this.user = pr.getProperty("user");
            this.password = pr.getProperty("password");
            this.port = Integer.parseInt(pr.getProperty("port"));
            this.localReplicaRoot = pr.getProperty("localReplicaRoot");
            this.remoteFilePath = pr.getProperty("remoteFilePath");
            mode = pr.getProperty("mode");

        } catch (Exception e) {
            logger.severe("Failed to load SFTP connection properties: " + e.getMessage());
        }
    }

    private void connect() throws Exception {
        if (session == null || !session.isConnected()) {
            session = jsch.getSession(user, host, port);
            session.setPassword(password);
            session.setConfig("StrictHostKeyChecking", "no");
            session.connect();
            sftpChannel = (ChannelSftp) session.openChannel("sftp");
            sftpChannel.connect();
            logger.info("SFTP connection established.");
        }
    }

    private void disconnect() {
        if (sftpChannel != null && sftpChannel.isConnected()) {
            sftpChannel.disconnect();
        }
        if (session != null && session.isConnected()) {
            session.disconnect();
        }
        logger.info("SFTP connection closed.");
    }

    public void syncFiles() {
        try {
            connect();
            List<String> localFiles = getLocalFileList(new File(localReplicaRoot));
            logger.info("Local files found: " + localFiles);  // Log local files found
            List<String> filesToReplace = new ArrayList<>();

            // Check files on remote, only download if they exist locally
            listAndCompareFiles(remoteFilePath, localFiles, filesToReplace);

            logger.info("Files to replace: " + filesToReplace);  // Log files to be replaced

            for (String remoteFile : filesToReplace) {
                downloadFile(remoteFile);
            }

            logger.info("Sync completed. Total files downloaded: " + filesToReplace.size());
        } catch (Exception e) {
            logger.severe("Error in syncFiles: " + e.getMessage());
        } finally {
            disconnect();
        }
    }

    // List local files and return a list of their paths relative to the localReplicaRoot
    private List<String> getLocalFileList(File localDir) {
        List<String> localFiles = new ArrayList<>();
        for (File file : localDir.listFiles()) {
            if (file.isFile()) {
                String relativePath = file.getPath().substring(localReplicaRoot.length()).replace("\\", "/");
                localFiles.add(relativePath);
            }
        }
        return localFiles;
    }

    // Compare remote directory and local file list
    private void listAndCompareFiles(String directory, List<String> localFiles, List<String> filesToReplace) throws SftpException {
        sftpChannel.cd(directory);
        List<ChannelSftp.LsEntry> entries = sftpChannel.ls("*");

        logger.info("Checking remote directory: " + directory);
        for (ChannelSftp.LsEntry entry : entries) {
            if (entry.getAttrs().isDir()) {
                // Recursively check subdirectories
                listAndCompareFiles(directory + "/" + entry.getFilename(), localFiles, filesToReplace);
            } else {
                String remoteFilePath = directory + "/" + entry.getFilename();
                String relativeRemotePath = remoteFilePath.substring(this.remoteFilePath.length()).replace("\\", "/");

                logger.info("Remote file relative path: " + relativeRemotePath);  // Log the remote relative path

                if (localFiles.contains(relativeRemotePath)) {
                    logger.info("File matched for download: " + relativeRemotePath);  // Log the matching file
                    filesToReplace.add(remoteFilePath);  // Add file to the list to be downloaded
                }
            }
        }
    }

    // Download a file from the remote server
    private void downloadFile(String remoteFilePath) {
        try {
            String localPath = replicateLocalPath(remoteFilePath);
            File localFile = new File(localPath);
            localFile.getParentFile().mkdirs(); // Create directories if needed

            try (InputStream inputStream = sftpChannel.get(remoteFilePath);
                 FileOutputStream fos = new FileOutputStream(localFile)) {
                byte[] buffer = new byte[1024];
                int readCount;
                while ((readCount = inputStream.read(buffer)) > 0) {
                    fos.write(buffer, 0, readCount);
                }
                logger.info("File downloaded successfully: " + remoteFilePath);
            }
        } catch (SftpException e) {
            logger.severe("Failed to get file from SFTP: " + remoteFilePath + " - " + e.getMessage());
        } catch (Exception e) {
            logger.severe("Error in downloadFile: " + e.getMessage());
        }
    }


    // Upload a file from local to the remote server
    private void uploadFile(String localFilePath) {
        try {
            String remotePath = replicateRemotePath(localFilePath);
            File localFile = new File(localFilePath);

            if (localFile.exists() && localFile.isFile()) {
                try (FileInputStream fis = new FileInputStream(localFile)) {
                    sftpChannel.put(fis, remotePath);
                    logger.info("File uploaded successfully: " + localFilePath);
                }
            }
        } catch (SftpException e) {
            logger.severe("Failed to upload file to SFTP: " + localFilePath + " - " + e.getMessage());
        } catch (Exception e) {
            logger.severe("Error in uploadFile: " + e.getMessage());
        }
    }

    // Replicate the remote directory structure based on the given local file path
    private String replicateRemotePath(String localFilePath) {
        return remoteFilePath + localFilePath.substring(localReplicaRoot.length()).replace("\\", "/");
    }

    // Replicate the directory structure locally based on the given SFTP file path
    private String replicateLocalPath(String sftpFilePath) {
        return localReplicaRoot + sftpFilePath.substring(remoteFilePath.length()).replace("/", "\\");
    }

    public static void main(String[] args) {
        SFTPFileTransfer sftpTool = new SFTPFileTransfer();

        // Example usage
        if (mode.equals("get")) {
            sftpTool.syncFiles(); // Sync files from remote to local
        } else if (mode.equals("set")) {
            // Implement upload functionality if required
        }
    }
}