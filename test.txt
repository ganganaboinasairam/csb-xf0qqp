<!DOCTYPE html>
<html>
<head>
    <title>Download Image via AJAX</title>
</head>
<body>
    <input type="text" id="c_img_indx" placeholder="Enter Image Index" required>
    <input type="text" id="c_main_ref" placeholder="Enter Main Reference" required>
    <button onclick="downloadImage()">Download Image</button>

    <script>
        function downloadImage() {
            const c_img_indx = document.getElementById('c_img_indx').value;
            const c_main_ref = document.getElementById('c_main_ref').value;

            if (!c_img_indx || !c_main_ref) {
                alert('Please enter both Image Index and Main Reference');
                return;
            }

            // Create the request URL with query parameters
            const url = `/yourApp/downloadImage?c_img_indx=${encodeURIComponent(c_img_indx)}&c_main_ref=${encodeURIComponent(c_main_ref)}`;

            // Use fetch to send the request to the servlet
            fetch(url, {
                method: 'GET'
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();  // Get the response as a Blob (binary data)
                } else {
                    throw new Error('Image not found');
                }
            })
            .then(blob => {
                // Create a download link for the image
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `image_${c_img_indx}.jpg`;  // Set the file name
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);  // Clean up
            })
            .catch(error => {
                alert('Error: ' + error.message);
            });
        }
    </script>
</body>
</html>

@WebServlet("/downloadImage")
public class ImageDownloadServlet extends HttpServlet {
    private static final long serialVersionUID = 1L;

    protected void doGet(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        String c_img_indx = request.getParameter("c_img_indx");
        String c_main_ref = request.getParameter("c_main_ref");

        // Database connection and query logic here...

        String query = "SELECT b_img_content FROM trx_image_dtal WHERE c_img_indx = ? AND c_main_ref = ?";
        try (PreparedStatement statement = connection.prepareStatement(query)) {
            statement.setString(1, c_img_indx);
            statement.setString(2, c_main_ref);

            try (ResultSet resultSet = statement.executeQuery()) {
                if (resultSet.next()) {
                    String base64Image = resultSet.getString("b_img_content");
                    byte[] imageBytes = Base64.getDecoder().decode(base64Image);

                    response.setContentType("image/jpeg"); // or image/png
                    response.setHeader("Content-Disposition", "attachment; filename=\"image_" + c_img_indx + ".jpg\"");

                    OutputStream out = response.getOutputStream();
                    out.write(imageBytes);
                    out.flush();
                } else {
                    response.sendError(HttpServletResponse.SC_NOT_FOUND, "Image not found");
                }
            }
        } catch (Exception e) {
            throw new ServletException("Error retrieving image", e);
        }
    }
}